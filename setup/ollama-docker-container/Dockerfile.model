ARG BASE_IMAGE=ollama-base:latest
FROM ${BASE_IMAGE}

# ビルド引数
ARG MODEL_NAME
ARG MODEL_FILE
ARG MODEL_CONFIG

# ラベル
LABEL model.name="${MODEL_NAME}"
LABEL model.file="${MODEL_FILE}"
LABEL model.config="${MODEL_CONFIG}"

# 環境変数設定
ENV MODEL_NAME=${MODEL_NAME}
ENV MODEL_FILE=${MODEL_FILE}
ENV MODEL_CONFIG=${MODEL_CONFIG}

# モデルファイルをコピー
COPY models/${MODEL_NAME}/ /app/models/${MODEL_NAME}/

# モデル設定ファイルをコピー
COPY configs/model-template.yml /app/config.yml

# モデル読み込みスクリプトを作成
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "Starting Ollama with model: $MODEL_NAME"\n\
\n\
# Ollamaサービスを開始\n\
/bin/ollama serve &\n\
OLLAMA_PID=$!\n\
\n\
# サービスの起動を待つ\n\
sleep 5\n\
\n\
# ヘルスチェック\n\
until curl -f http://localhost:11434/api/tags >/dev/null 2>&1; do\n\
    echo "Waiting for Ollama to start..."\n\
    sleep 2\n\
done\n\
\n\
# モデルファイルが存在する場合は読み込み\n\
if [ -f "/app/models/$MODEL_NAME/Modelfile" ]; then\n\
    echo "Loading model from Modelfile..."\n\
    cd /app/models/$MODEL_NAME\n\
    /bin/ollama create $MODEL_NAME -f Modelfile\n\
    echo "Model $MODEL_NAME loaded successfully!"\n\
elif [ -f "/app/models/$MODEL_NAME/model.bin" ]; then\n\
    echo "Model binary found, but Modelfile missing."\n\
    echo "Please ensure Modelfile exists in /app/models/$MODEL_NAME/"\n\
else\n\
    echo "No model files found in /app/models/$MODEL_NAME/"\n\
fi\n\
\n\
# モデル一覧を表示\n\
echo "Available models:"\n\
/bin/ollama list\n\
\n\
echo "Ollama container with model $MODEL_NAME is ready!"\n\
echo "Access API at http://localhost:11434"\n\
\n\
# フォアグラウンドでプロセスを維持\n\
wait $OLLAMA_PID' > /app/start-model.sh && chmod +x /app/start-model.sh

# 起動コマンドを上書き
CMD ["/app/start-model.sh"]